<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>配信ポイント集計ツール</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --muted:#9fb1ce; --ink:#eef2ff; --accent:#22c55e; --accent-2:#06b6d4; --warn:#f59e0b; --danger:#ef4444; --border:#1f2937;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      color:var(--ink); background:radial-gradient(1200px 600px at 70% -10%, #0b1224 0%, #0f172a 40%, #0b1224 100%);
    }
    header{ position:sticky; top:0; z-index:10; backdrop-filter:saturate(140%) blur(6px); background:rgba(11,18,36,.6); border-bottom:1px solid var(--border); }
    header .wrap{ max-width:1200px; margin:0 auto; display:flex; align-items:center; gap:16px; padding:12px 16px; }
    h1{ font-size:18px; margin:0; letter-spacing:.04em; }
    main{ max-width:1200px; margin:18px auto; padding:0 16px 32px; }

    .grid{ display:grid; grid-template-columns: 300px 1fr 480px; gap:16px; align-items:start; }

    .card{ background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)); border:1px solid var(--border); border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,.25); overflow:hidden; }
    .card h2{ font-size:14px; text-transform:uppercase; letter-spacing:.12em; color:var(--muted); margin:0; padding:12px 14px; border-bottom:1px solid var(--border); }
    .card .body{ padding:14px; }

    /* 左列：名前 */
    .name-tools{ display:flex; gap:8px; margin-bottom:10px; }
    .name-tools input{ flex:1; background:#0b1327; color:var(--ink); border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
    .btn{ border:1px solid var(--border); background:#0e172b; color:var(--ink); padding:9px 12px; border-radius:10px; font-weight:600; cursor:pointer; transition:.15s transform, .2s background, .2s border-color, .2s opacity; }
    .btn:hover{ transform:translateY(-1px); border-color:#2a3a55; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    .btn.primary{ background:linear-gradient(180deg, #27c164, #1fb157); border-color:#1b8c47; }
    .btn.warn{ background:linear-gradient(180deg, #fbbf24, #f59e0b); border-color:#b45309; color:#1b1b1b; }
    .btn.ghost{ background:transparent; }

    .name-list{ display:grid; gap:8px; max-height:520px; overflow:auto; padding-right:4px; }
    .name-item{ display:flex; align-items:center; gap:8px; }
    .name-btn{ flex:1; text-align:left; padding:10px 12px; background:#0b1327; border:1px solid var(--border); border-radius:10px; cursor:pointer; font-weight:700; }
    .name-btn.active{ outline:2px solid var(--accent-2); box-shadow:0 0 0 3px rgba(6,182,212,.25) inset; }
    .name-del{ width:36px; height:36px; border-radius:10px; background:#1a2338; border:1px solid var(--border); cursor:pointer; }

    /* 中央：集計対象ボタン */
    .tags{ display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:10px; }
    .tag-btn{ display:flex; flex-direction:column; gap:6px; align-items:flex-start; justify-content:center; padding:12px; border-radius:12px; border:1px dashed #2a3552; background:rgba(12,20,40,.6); cursor:pointer; }
    .tag-btn small{ color:var(--muted); font-weight:600; letter-spacing:.02em; }
    .tag-btn strong{ font-size:16px; }
    .tag-btn:hover{ border-color:#3a4a72; background:rgba(16,26,50,.8); }

    .hint{ color:var(--muted); font-size:13px; margin-top:8px; }

    /* 右列：ランキング（個人） */
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    thead th{ position:sticky; top:0; background:#0b1224; border-bottom:1px solid var(--border); padding:10px; font-size:12px; color:var(--muted); text-align:left; }
    tbody td{ padding:10px; border-bottom:1px dashed #20314d; }
    tbody tr:hover{ background:rgba(255,255,255,.02); }
    .rank{ width:56px; text-align:right; padding-right:4px; }
    .total{ font-weight:800; font-size:16px; }

    .inline{ display:inline-flex; gap:6px; align-items:center; }

    /* 見やすい内訳ピル */
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:7px 10px; border:1px solid #3b4f78; background:#13203a; border-radius:999px; font-size:14px; color:#ffffff; font-weight:700; letter-spacing:.01em; }
    .pill b{ color:#a5b4fc; font-weight:800; }
    .pill .muted{ color:#d1d5db; font-weight:700; }
    details{ background:#0b1327; border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
    details > summary{ cursor:pointer; list-style:none; font-weight:800; }
    details > summary::-webkit-details-marker{ display:none; }

    .foot-tools{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .right-head{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border); }
    .right-head h2{ border:0; padding:0; }

    @media (max-width: 1100px){ .grid{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>配信ポイント集計ツール</h1>
      <span class="tag">アクティブ: <b id="activeNamePill">未選択</b></span>
      <div class="inline" style="margin-left:auto;gap:10px;">
        <button class="btn ghost" id="exportJsonBtn">エクスポート(JSON)</button>
        <input type="file" id="importJsonInput" accept="application/json" style="display:none;" />
        <button class="btn ghost" id="importJsonBtn">インポート(JSON)</button>
        <button class="btn warn" id="resetAllBtn">全リセット</button>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- 左：名前一覧 -->
      <section class="card">
        <h2>名前一覧</h2>
        <div class="body">
          <div class="name-tools">
            <input id="newName" placeholder="名前を入力" />
            <button class="btn primary" id="addNameBtn">追加</button>
          </div>
          <div class="name-list" id="nameList"></div>
          <p class="hint">名前を選択 → 右の「集計対象」ボタンで操作します。</p>
        </div>
      </section>

      <!-- 中央：集計対象（= 三点セットのみ） -->
      <section class="card">
        <h2>集計対象（クリック / タップで操作）</h2>
        <div class="body">
          <div class="tags" id="targetButtons"></div>
          <p class="hint" id="hintText">ヒント：</p>
        </div>
      </section>

      <!-- 右：ランキング（個人） -->
      <section class="card">
        <div class="right-head">
          <h2>ランキング / 内訳</h2>
          <span class="tag">合計 = 内訳 × 既定ポイント</span>
        </div>
        <div class="body">
          <div style="max-height:540px; overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th class="rank">#</th>
                  <th>名前</th>
                  <th style="width:100px;">合計</th>
                  <th>内訳</th>
                </tr>
              </thead>
              <tbody id="rankingBody"></tbody>
            </table>
          </div>
          <div class="foot-tools">
            <button class="btn" id="sortAlphaBtn">名前順で並べ替え</button>
            <button class="btn" id="sortScoreBtn">得点順で並べ替え</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // --- 設定 ---
    const STORAGE_KEY = "points-tracker-v2";

    // 「三点セット」だけ、1pt
    const TARGETS = [
      { key:"三点セット", pt:1 },
    ];

    // 初期メンバーは空（随時追加）
    const DEFAULT_NAMES = [];

    // タッチ端末（スマホ/タブレット）判定
    const IS_MOBILE = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

    // --- 状態 ---
    let state = loadState() || {
      people: {}, // name -> { counts: {key: number} }
      order: [],  // 表示順（登録順）
      active: null,
      sort: "score", // or "alpha"
    };

    // --- ユーティリティ ---
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function loadState(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch{ return null; } }
    function ensurePerson(name){
      if(!state.people[name]){
        state.people[name] = { counts:{} };
        TARGETS.forEach(t=> state.people[name].counts[t.key] = 0);
        state.order.push(name);
      }
    }
    function addPerson(name){
      const n = name.trim();
      if(!n) return;
      if(state.people[n]){ alert("同名が存在します"); return; }
      ensurePerson(n);
      state.active = n;
    }
    function delPerson(name){
      if(!confirm(`${name} を削除しますか？`)) return;
      delete state.people[name];
      state.order = state.order.filter(x=>x!==name);
      if(state.active === name) state.active = null;
    }

    function totalScore(name){
      const p = state.people[name];
      return TARGETS.reduce((sum,t)=> sum + (p.counts[t.key]||0) * t.pt, 0);
    }

    function handleTagClick(key, delta){
      const active = state.active;
      if(!active){ alert("先に名前を選択してください"); return; }
      const c = state.people[active].counts;
      c[key] = Math.max(0, (c[key]||0) + delta);
      renderAll(); saveState();
    }

    function exportJson(){
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `points_v2_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function importJson(file){
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const data = JSON.parse(reader.result);
          if(!data.people || !data.order){ throw new Error("形式が不正です"); }
          state = data; renderAll(); saveState();
        }catch(e){ alert("読み込みに失敗しました: " + e.message); }
      };
      reader.readAsText(file);
    }

    function resetAll(){
      if(!confirm("全データを削除して初期化しますか？")) return;
      localStorage.removeItem(STORAGE_KEY);
      state = { people:{}, order:[], active:null, sort:"score" };
      renderAll(); saveState();
    }

    // --- 描画 ---
    function renderNames(){
      const wrap = document.getElementById('nameList');
      wrap.innerHTML = '';
      state.order.forEach(name=>{
        if(!state.people[name]) return;
        const row = document.createElement('div'); row.className = 'name-item';
        const btn = document.createElement('button'); btn.className = 'name-btn'; btn.textContent = name;
        if(state.active === name) btn.classList.add('active');
        btn.onclick = ()=>{ state.active = name; renderAll(); saveState(); };
        const del = document.createElement('button'); del.className='name-del'; del.title='削除'; del.textContent='✕';
        del.onclick = ()=>{ delPerson(name); renderAll(); saveState(); };
        row.append(btn, del); wrap.appendChild(row);
      });
      document.getElementById('activeNamePill').textContent = state.active || '未選択';
    }

    function renderTargets(){
      const wrap = document.getElementById('targetButtons');
      wrap.innerHTML = '';

      // ヒント文言をデバイス別に
      const hint = document.getElementById('hintText');
      if (hint) {
        hint.innerHTML = IS_MOBILE
          ? 'ヒント：<b>タップ</b>で<em>+1（加点）</em>、<b>長押し（約0.5秒）</b>で<em>-1（取り消し）</em>ができます。'
          : 'ヒント：<b>クリック</b>で<em>+1</em>、<b>Shift+クリック</b>で<em>-1（取り消し）</em>ができます。';
      }

      TARGETS.forEach(t=>{
        const b = document.createElement('button');
        b.className='tag-btn';
        b.innerHTML = `<strong>${t.key}</strong><small>+${t.pt} pt</small>`;

        if (IS_MOBILE) {
          // スマホ：タップ＝+1、長押し＝-1
          let longPressTimer = null;
          let longPressed = false;

          const onStart = () => {
            longPressed = false;
            longPressTimer = setTimeout(()=>{
              longPressed = true;
              handleTagClick(t.key, -1); // 長押しで減点
            }, 500); // 長押し閾値
          };
          const onEnd = () => {
            if (longPressTimer) clearTimeout(longPressTimer);
            // 長押しでなければ単タップ → 加点
            if (!longPressed) handleTagClick(t.key, +1);
          };

          b.addEventListener('touchstart', onStart, {passive:true});
          b.addEventListener('touchend', onEnd);
          b.addEventListener('touchcancel', ()=>{ if(longPressTimer) clearTimeout(longPressTimer); });
        } else {
          // PC：クリック=+1、Shift+クリック=-1
          b.onclick = (e)=> handleTagClick(t.key, e.shiftKey ? -1 : +1);
        }

        wrap.appendChild(b);
      });
    }

    function renderRanking(){
      const body = document.getElementById('rankingBody');
      body.innerHTML = '';
      const rows = Object.keys(state.people).map(name=>({
        name,
        total: totalScore(name),
        counts: {...state.people[name].counts},
      }));

      if(state.sort === 'alpha') rows.sort((a,b)=> a.name.localeCompare(b.name, 'ja'));
      else rows.sort((a,b)=> b.total - a.total || a.name.localeCompare(b.name,'ja'));

      rows.forEach((row, idx)=>{
        const tr = document.createElement('tr');
        const rank = document.createElement('td'); rank.className='rank'; rank.textContent = idx+1;
        const name = document.createElement('td'); name.textContent = row.name; if(state.active===row.name){ name.style.fontWeight='800'; }
        const total = document.createElement('td'); total.className='total'; total.textContent = row.total;
        const detail = document.createElement('td');

        const det = document.createElement('details');
        const sum = document.createElement('summary');
        sum.textContent = '内訳を表示';
        det.appendChild(sum);

        const list = document.createElement('div'); list.style.display='grid'; list.style.gridTemplateColumns='repeat(2, minmax(0,1fr))'; list.style.gap='8px'; list.style.marginTop='10px';
        TARGETS.forEach(t=>{
          const count = row.counts[t.key] || 0;
          const pill = document.createElement('span'); pill.className='pill';
          pill.innerHTML = `<b>${t.key}</b> × <span class="muted">${count}</span> = <b>${count * t.pt}</b>`;
          list.appendChild(pill);
        });
        det.appendChild(list);
        detail.appendChild(det);

        tr.append(rank, name, total, detail); body.appendChild(tr);
      });
    }

    function renderAll(){
      renderNames(); renderTargets(); renderRanking();
    }

    // --- イベント ---
    document.getElementById('addNameBtn').onclick = ()=>{
      const v = document.getElementById('newName').value;
      addPerson(v); document.getElementById('newName').value = '';
      renderAll(); saveState();
    };
    document.getElementById('newName').addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ document.getElementById('addNameBtn').click(); }
    });

    document.getElementById('sortAlphaBtn').onclick = ()=>{ state.sort='alpha'; renderAll(); saveState(); };
    document.getElementById('sortScoreBtn').onclick = ()=>{ state.sort='score'; renderAll(); saveState(); };

    document.getElementById('exportJsonBtn').onclick = exportJson;
    document.getElementById('importJsonBtn').onclick = ()=> document.getElementById('importJsonInput').click();
    document.getElementById('importJsonInput').addEventListener('change', e=>{
      const f = e.target.files[0]; if(f) importJson(f);
    });

    document.getElementById('resetAllBtn').onclick = resetAll;

    // 起動：不足キーを補完（将来定義追加に備え）
    Object.keys(state.people).forEach(n=>{
      TARGETS.forEach(t=>{ if(!(t.key in state.people[n].counts)) state.people[n].counts[t.key]=0; });
    });
    renderAll();
  </script>
</body>
</html>
